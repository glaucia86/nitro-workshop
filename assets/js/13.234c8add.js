(window.webpackJsonp=window.webpackJsonp||[]).push([[13],{227:function(t,a,s){"use strict";s.r(a);var e=s(2),n=Object(e.a)({},(function(){var t=this,a=t.$createElement,s=t._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"_4-integrate-file-upload"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-integrate-file-upload"}},[t._v("#")]),t._v(" 4. Integrate file upload")]),t._v(" "),s("p",[t._v("Our API is starting to look great now that we can add new stories, but it would be even better if we could attach some cute pictures to our stories, right?")]),t._v(" "),s("h2",{attrs:{id:"configure-azure-storage-module"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#configure-azure-storage-module"}},[t._v("#")]),t._v(" Configure Azure Storage module")]),t._v(" "),s("p",[t._v("We will use "),s("a",{attrs:{href:"https://azure.microsoft.com/services/storage/blobs/?WT.mc_id=nitro-workshop-yolasors",target:"_blank",rel:"noopener noreferrer"}},[t._v("Azure Blob Storage"),s("OutboundLink")],1),t._v(" to store pets images in the cloud. It can be used to store any kind of file, and is also capable of "),s("a",{attrs:{href:"https://docs.microsoft.com/azure/storage/blobs/storage-blob-static-website?WT.mc_id=nitro-workshop-yolasors",target:"_blank",rel:"noopener noreferrer"}},[t._v("hosting static websites"),s("OutboundLink")],1),t._v(".")]),t._v(" "),s("p",[t._v("As you already created a storage account in "),s("a",{attrs:{href:"/step2"}},[t._v("Step 2")]),t._v(", you only need to integrate the "),s("code",[t._v("@nestjs/azure-storage")]),t._v(" package with this command:")]),t._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("npm")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" @nestjs/azure-storage\n")])])]),s("p",[t._v("Open the file "),s("code",[t._v("src/app.module.ts")]),t._v(" and add the "),s("code",[t._v("AzureStorageModule")]),t._v(" to the module imports:")]),t._v(" "),s("div",{staticClass:"language-ts extra-class"},[s("pre",{pre:!0,attrs:{class:"language-ts"}},[s("code",[t._v("@"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Module")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  imports"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n    AzureStorageModule"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("withConfig")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      sasKey"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" process"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("env"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("AZURE_STORAGE_SAS_KEY")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      accountName"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" process"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("env"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("AZURE_STORAGE_ACCOUNT")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      containerName"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'nitro-cats-container'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n")])])]),s("p",[t._v("TODO: PR to remove the env variables!")]),t._v(" "),s("p",[t._v("Don't forget to add the missing imports at the top:")]),t._v(" "),s("div",{staticClass:"language-ts extra-class"},[s("pre",{pre:!0,attrs:{class:"language-ts"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" AzureStorageModule "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'@nestjs/azure-storage'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("h2",{attrs:{id:"handle-file-upload"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#handle-file-upload"}},[t._v("#")]),t._v(" Handle file upload")]),t._v(" "),s("p",[t._v("Now let's update the "),s("code",[t._v("POST /api/stories")]),t._v(" endpoint to add support for image upload.")]),t._v(" "),s("ol",{attrs:{start:"2"}},[s("li",[t._v("Update cat entity to support an image URL")]),t._v(" "),s("li",[t._v("Update post cat fact endpoint with storage interceptor to")]),t._v(" "),s("li",[t._v("Test file upload with curl")]),t._v(" "),s("li",[t._v("Add some restrictions on uploaded files and error management: file size, dimensionsâ€¦")]),t._v(" "),s("li",[t._v("Test again with curl, fail/success")]),t._v(" "),s("li",[t._v("Redeploy")]),t._v(" "),s("li",[t._v("Test with frontend")])])])}),[],!1,null,null,null);a.default=n.exports}}]);
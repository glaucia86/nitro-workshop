<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Step 4 | Nitro workshop</title>
    <meta name="description" content="Learn how to make Node.js serverless REST APIs with NestJS and Azure">
    <link rel="icon" href="/nitro-workshop/nitro.png">
  <meta name="theme-color" content="#0078d7">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="msapplication-TileColor" content="#0078d7">
    <meta property="og:image" content="https://nitro-stack.github.io/nitro-workshop/nitro.png"><meta name="twitter:image" content="https://nitro-stack.github.io/nitro-workshop/nitro.png"><meta property="og:description" content="Learn how to make Node.js serverless REST APIs with NestJS and Azure"><meta name="twitter:description" content="Learn how to make Node.js serverless REST APIs with NestJS and Azure"><meta itemprop="description" content="Learn how to make Node.js serverless REST APIs with NestJS and Azure"><meta property="og:url" content="https://nitro-stack.github.io/nitro-workshop/step4.html"><meta name="twitter:url" content="https://nitro-stack.github.io/nitro-workshop/step4.html"><meta property="og:title" content="Step 4"><meta name="twitter:title" content="Step 4"><meta itemprop="name" content="Step 4"><meta property="og:type" content="website"><meta name="twitter:card" content="summary"><meta property="og:site_name" content="Nitro Workshop"><meta name="twitter:site" content="@sinedied"><meta name="twitter:creator" content="@sinedied">
    <link rel="preload" href="/nitro-workshop/assets/css/0.styles.50f1f6e2.css" as="style"><link rel="preload" href="/nitro-workshop/assets/js/app.895cd663.js" as="script"><link rel="preload" href="/nitro-workshop/assets/js/3.17fad2df.js" as="script"><link rel="preload" href="/nitro-workshop/assets/js/2.89622c55.js" as="script"><link rel="preload" href="/nitro-workshop/assets/js/14.4af8a3f8.js" as="script"><link rel="preload" href="/nitro-workshop/assets/js/5.3a590768.js" as="script"><link rel="prefetch" href="/nitro-workshop/assets/js/10.f140f831.js"><link rel="prefetch" href="/nitro-workshop/assets/js/11.4fb4abe8.js"><link rel="prefetch" href="/nitro-workshop/assets/js/12.a622ec17.js"><link rel="prefetch" href="/nitro-workshop/assets/js/13.7c72207c.js"><link rel="prefetch" href="/nitro-workshop/assets/js/15.f18ae210.js"><link rel="prefetch" href="/nitro-workshop/assets/js/16.8be28db5.js"><link rel="prefetch" href="/nitro-workshop/assets/js/4.1c62fd6e.js"><link rel="prefetch" href="/nitro-workshop/assets/js/6.ee9cf466.js"><link rel="prefetch" href="/nitro-workshop/assets/js/7.b3f3a4a8.js"><link rel="prefetch" href="/nitro-workshop/assets/js/8.dcfa686b.js"><link rel="prefetch" href="/nitro-workshop/assets/js/9.2c440a67.js">
    <link rel="stylesheet" href="/nitro-workshop/assets/css/0.styles.50f1f6e2.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/nitro-workshop/" class="home-link router-link-active"><img src="/nitro-workshop/nitro.png" alt="Nitro workshop" class="logo"> <span class="site-name can-hide">Nitro workshop</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/nitro-workshop/" class="nav-link">Home</a></div><div class="nav-item"><a href="/nitro-workshop/intro.html" class="nav-link">Workshop</a></div><div class="nav-item"><a href="https://nitr.ooo" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Nitro website
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/nitro-workshop/" class="nav-link">Home</a></div><div class="nav-item"><a href="/nitro-workshop/intro.html" class="nav-link">Workshop</a></div><div class="nav-item"><a href="https://nitr.ooo" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Nitro website
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/nitro-workshop/intro.html" class="sidebar-link">Introduction</a></li><li><a href="/nitro-workshop/env.html" class="sidebar-link">Prerequisites</a></li><li><a href="/nitro-workshop/step1/" class="sidebar-link">Step 1</a></li><li><a href="/nitro-workshop/step2/" class="sidebar-link">Step 2</a></li><li><a href="/nitro-workshop/step3/" class="sidebar-link">Step 3</a></li><li><a href="/nitro-workshop/conclusion.html" class="sidebar-link">Conclusion</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_4-integrate-file-upload"><a href="#_4-integrate-file-upload" class="header-anchor">#</a> 4. Integrate file upload</h1> <p>Our API is starting to look great now that we can add new stories, but it would be even better if we could attach some cute pictures to our stories, right?</p> <h2 id="configure-azure-storage-module"><a href="#configure-azure-storage-module" class="header-anchor">#</a> Configure Azure Storage module</h2> <p>We will use <a href="https://azure.microsoft.com/services/storage/blobs/?WT.mc_id=nitro-workshop-yolasors" target="_blank" rel="noopener noreferrer">Azure Blob Storage<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> to store pets images in the cloud. It can be used to store any kind of file, and is also capable of <a href="https://docs.microsoft.com/azure/storage/blobs/storage-blob-static-website?WT.mc_id=nitro-workshop-yolasors" target="_blank" rel="noopener noreferrer">hosting static websites<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <p>As you already created a storage account in <a href="/step2">Step 2</a>, you only need to integrate the <code>@nestjs/azure-storage</code> package with this command:</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">npm</span> <span class="token function">install</span> @nestjs/azure-storage
</code></pre></div><p>Open the file <code>src/app.module.ts</code> and add the <code>AzureStorageModule</code> to the module imports:</p> <div class="language-ts extra-class"><pre class="language-ts"><code>@<span class="token function">Module</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    AzureStorageModule<span class="token punctuation">.</span><span class="token function">withConfig</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      sasKey<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">AZURE_STORAGE_SAS_KEY</span><span class="token punctuation">,</span>
      accountName<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">AZURE_STORAGE_ACCOUNT</span><span class="token punctuation">,</span>
      containerName<span class="token punctuation">:</span> <span class="token string">'nitro-cats-container'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token operator">...</span>
  <span class="token punctuation">]</span>
</code></pre></div><p>TODO: PR to remove the env variables!</p> <p>Don't forget to add the missing imports at the top:</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> AzureStorageModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/azure-storage'</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="handle-file-upload"><a href="#handle-file-upload" class="header-anchor">#</a> Handle file upload</h2> <p>Now let's update the <code>POST /api/stories</code> endpoint to add support for image upload.</p> <ol start="2"><li>Update cat entity to support an image URL</li> <li>Update post cat fact endpoint with storage interceptor to</li> <li>Test file upload with curl</li> <li>Add some restrictions on uploaded files and error management: file size, dimensions…</li> <li>Test again with curl, fail/success</li> <li>Redeploy</li> <li>Test with frontend</li></ol></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/nitro-workshop/assets/js/app.895cd663.js" defer></script><script src="/nitro-workshop/assets/js/3.17fad2df.js" defer></script><script src="/nitro-workshop/assets/js/2.89622c55.js" defer></script><script src="/nitro-workshop/assets/js/14.4af8a3f8.js" defer></script><script src="/nitro-workshop/assets/js/5.3a590768.js" defer></script>
  </body>
</html>

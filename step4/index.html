<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>4. Integrate file upload | Nitro workshop</title>
    <meta name="description" content="Learn how to make Node.js serverless REST APIs with NestJS and Azure">
    <link rel="icon" href="/nitro-workshop/nitro.png">
  <meta name="theme-color" content="#0078d7">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="msapplication-TileColor" content="#0078d7">
    <meta property="og:image" content="https://nitro-stack.github.io/nitro-workshop/nitro.png"><meta name="twitter:image" content="https://nitro-stack.github.io/nitro-workshop/nitro.png"><meta property="og:description" content="Learn how to make Node.js serverless REST APIs with NestJS and Azure"><meta name="twitter:description" content="Learn how to make Node.js serverless REST APIs with NestJS and Azure"><meta itemprop="description" content="Learn how to make Node.js serverless REST APIs with NestJS and Azure"><meta property="og:url" content="https://nitro-stack.github.io/nitro-workshop/step4.html"><meta name="twitter:url" content="https://nitro-stack.github.io/nitro-workshop/step4.html"><meta property="og:title" content="4. Integrate file upload"><meta name="twitter:title" content="4. Integrate file upload"><meta itemprop="name" content="4. Integrate file upload"><meta property="og:type" content="website"><meta name="twitter:card" content="summary"><meta property="og:site_name" content="Nitro Workshop"><meta name="twitter:site" content="@sinedied"><meta name="twitter:creator" content="@sinedied">
    <link rel="preload" href="/nitro-workshop/assets/css/0.styles.e0ba4cd8.css" as="style"><link rel="preload" href="/nitro-workshop/assets/js/app.4b20a700.js" as="script"><link rel="preload" href="/nitro-workshop/assets/js/2.37e49c15.js" as="script"><link rel="preload" href="/nitro-workshop/assets/js/10.a7d61bf4.js" as="script"><link rel="preload" href="/nitro-workshop/assets/js/4.f4ff603a.js" as="script"><link rel="prefetch" href="/nitro-workshop/assets/js/11.63366b7d.js"><link rel="prefetch" href="/nitro-workshop/assets/js/12.569b53b7.js"><link rel="prefetch" href="/nitro-workshop/assets/js/13.2d0211e8.js"><link rel="prefetch" href="/nitro-workshop/assets/js/14.cb508a72.js"><link rel="prefetch" href="/nitro-workshop/assets/js/15.9aa5f87e.js"><link rel="prefetch" href="/nitro-workshop/assets/js/3.8d928ecf.js"><link rel="prefetch" href="/nitro-workshop/assets/js/5.b38633cc.js"><link rel="prefetch" href="/nitro-workshop/assets/js/6.288635af.js"><link rel="prefetch" href="/nitro-workshop/assets/js/7.b8708583.js"><link rel="prefetch" href="/nitro-workshop/assets/js/8.bf8be91b.js"><link rel="prefetch" href="/nitro-workshop/assets/js/9.e035ea19.js">
    <link rel="stylesheet" href="/nitro-workshop/assets/css/0.styles.e0ba4cd8.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/nitro-workshop/" class="home-link router-link-active"><img src="/nitro-workshop/nitro.png" alt="Nitro workshop" class="logo"> <span class="site-name can-hide">Nitro workshop</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/nitro-workshop/" class="nav-link">Home</a></div><div class="nav-item"><a href="/nitro-workshop/intro.html" class="nav-link">Workshop</a></div><div class="nav-item"><a href="https://nitr.ooo" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Nitro website
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/nitro-stack/nitro-workshop" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/nitro-workshop/" class="nav-link">Home</a></div><div class="nav-item"><a href="/nitro-workshop/intro.html" class="nav-link">Workshop</a></div><div class="nav-item"><a href="https://nitr.ooo" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Nitro website
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/nitro-stack/nitro-workshop" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/nitro-workshop/intro.html" class="sidebar-link">Introduction</a></li><li><a href="/nitro-workshop/env.html" class="sidebar-link">0. Prerequisites</a></li><li><a href="/nitro-workshop/step1/" class="sidebar-link">1. Bootstrap project</a></li><li><a href="/nitro-workshop/step2/" class="sidebar-link">2. Deploy application</a></li><li><a href="/nitro-workshop/step3/" class="sidebar-link">3. Add database</a></li><li><a href="/nitro-workshop/step4/" class="active sidebar-link">4. Integrate file upload</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/nitro-workshop/step4/#configure-azure-storage-module" class="sidebar-link">Configure Azure Storage module</a></li><li class="sidebar-sub-header"><a href="/nitro-workshop/step4/#handle-file-upload" class="sidebar-link">Handle file upload</a></li><li class="sidebar-sub-header"><a href="/nitro-workshop/step4/#test-your-endpoint" class="sidebar-link">Test your endpoint</a></li><li class="sidebar-sub-header"><a href="/nitro-workshop/step4/#limit-accepted-file-type-size" class="sidebar-link">Limit accepted file type/size</a></li><li class="sidebar-sub-header"><a href="/nitro-workshop/step4/#redeploy" class="sidebar-link">Redeploy</a></li></ul></li><li><a href="/nitro-workshop/step5/" class="sidebar-link">5. Extras</a></li><li><a href="/nitro-workshop/conclusion.html" class="sidebar-link">Conclusion</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_4-integrate-file-upload"><a href="#_4-integrate-file-upload" class="header-anchor">#</a> 4. Integrate file upload</h1> <p>Our API is starting to look great now that we can add new stories. But it would be even better if we could attach some cute pictures to our stories, right?</p> <p><img src="/nitro-workshop/assets/img/happycat.b0ef3f29.jpg" alt="happy cay saying yes" width="400"></p> <h2 id="configure-azure-storage-module"><a href="#configure-azure-storage-module" class="header-anchor">#</a> Configure Azure Storage module</h2> <p>We will use <a href="https://azure.microsoft.com/services/storage/blobs/?WT.mc_id=nitro-workshop-yolasors&amp;ocid=aid2462702_ThankYou_DevComm&amp;eventId=SnowcampWorkshop__J-5rEio2r5p" target="_blank" rel="noopener noreferrer">Azure Blob Storage<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> to store pets images in the cloud. It can be used to store any kind of file, and is also capable of <a href="https://docs.microsoft.com/azure/storage/blobs/storage-blob-static-website?WT.mc_id=nitro-workshop-yolasors&amp;ocid=aid2462702_ThankYou_DevComm&amp;eventId=SnowcampWorkshop__J-5rEio2r5p" target="_blank" rel="noopener noreferrer">hosting static websites<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <p>As you already created a storage account in <a href="/step2">Step 2</a>, you only need to integrate the <code>@nestjs/azure-storage</code> package with this command:</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">npm</span> <span class="token function">install</span> @nestjs/azure-storage
</code></pre></div><p>Open the file <code>src/app.module.ts</code> and add the <code>AzureStorageModule</code> to the module imports:</p> <div class="language-ts extra-class"><pre class="language-ts"><code>@<span class="token function">Module</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    AzureStorageModule<span class="token punctuation">.</span><span class="token function">withConfig</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      sasKey<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">AZURE_STORAGE_SAS_KEY</span><span class="token punctuation">,</span>
      accountName<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">AZURE_STORAGE_ACCOUNT</span><span class="token punctuation">,</span>
      containerName<span class="token punctuation">:</span> <span class="token string">'funpets-images'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token operator">...</span>
  <span class="token punctuation">]</span>
</code></pre></div><p>Don't forget to add the missing imports at the top:</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> AzureStorageModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/azure-storage'</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="handle-file-upload"><a href="#handle-file-upload" class="header-anchor">#</a> Handle file upload</h2> <p>Now let's update the <code>POST /api/stories</code> endpoint to add support for image upload.</p> <p>Open <code>src/stories/stories.controller.ts</code> and update the function you created to create new stories:</p> <ul><li>Add <code>@UseInterceptors(AzureStorageFileInterceptor('file'))</code> just below the <code>@Post()</code> annotation.</li> <li>Add <code>@UploadedFile() file: UploadedFileMetadata</code> in the function parameters.</li></ul> <p>Don't forget to also add the missing imports at the top:</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> FileInterceptor <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/platform-express'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AzureStorageFileInterceptor<span class="token punctuation">,</span> UploadedFileMetadata <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/azure-storage'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> UseInterceptors<span class="token punctuation">,</span> UploadedFile <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
</code></pre></div><p>The <code>AzureStorageFileInterceptor</code> will directly upload the file to Azure Storage container <code>funpets-images</code> specified in the module configuration, and will fill in the stored file url in <code>file.storageUrl</code>.</p> <p>Once you have the storage URL you can set the <code>imageUrl</code> of the created <code>Story</code> entity.</p> <p>Your final function should looks like this:</p> <div class="language-ts extra-class"><pre class="language-ts"><code>@<span class="token function">Post</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
@<span class="token function">UseInterceptors</span><span class="token punctuation">(</span><span class="token function">AzureStorageFileInterceptor</span><span class="token punctuation">(</span><span class="token string">'file'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token function">createStory</span><span class="token punctuation">(</span>
  @<span class="token function">Body</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  data<span class="token punctuation">:</span> Partial<span class="token operator">&lt;</span>Story<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  @<span class="token function">UploadedFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  file<span class="token punctuation">:</span> UploadedFileMetadata<span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>Story<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> story <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Story</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>story<span class="token punctuation">.</span>createdAt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    story<span class="token punctuation">.</span>createdAt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>file<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    story<span class="token punctuation">.</span>imageUrl <span class="token operator">=</span> file<span class="token punctuation">.</span>storageUrl <span class="token operator">||</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>storiesRepository<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>story<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="test-your-endpoint"><a href="#test-your-endpoint" class="header-anchor">#</a> Test your endpoint</h2> <p>After you finished the modifications, start your server using the functions emulator:</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">npm</span> run start:azure
</code></pre></div><p>After the server is started, you can test if uploading file works using <code>curl</code>:</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">curl</span> http://localhost:7071/api/stories <span class="token punctuation">\</span>
  -F <span class="token string">&quot;file=@&lt;path_to_image_file&gt;&quot;</span> <span class="token punctuation">\</span>
  -F <span class="token string">&quot;animal=cat&quot;</span> <span class="token punctuation">\</span>
  -F <span class="token string">&quot;description=Happy cat&quot;</span>
</code></pre></div><p>You can download and use the <a href="#_4-integrate-file-upload">the happy cat image</a> to test the file upload if don't have an image at hand.</p> <div class="custom-block info"><p class="custom-block-title">Note</p> <p>Using the <code>-F</code> curl option will automatically set the request content type to <code>multipart/form-data</code> which is required for Nest.js file upload support. Note that in that case, the payload for the <code>Story</code> property will also have to be form data and not JSON, as you can see in the curl command.</p></div> <h2 id="limit-accepted-file-type-size"><a href="#limit-accepted-file-type-size" class="header-anchor">#</a> Limit accepted file type/size</h2> <p>Your API now support file uploads, but surely you don't want <em>any</em> file to be uploaded and may want to set some reasonable limits on file size?</p> <p>Just like the base NestJS <a href="https://docs.nestjs.com/techniques/file-upload#basic-example" target="_blank" rel="noopener noreferrer"><code>FileInterceptor</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, the <code>AzureStorageFileInterceptor()</code> decorator supports a second <code>options</code> argument. The <code>options</code> object is of type <code>MulterOptions</code> and can be used to achieve what we want, using the <code>limits</code> and <code>fileFilter</code> properties. This is the same object used by <a href="https://github.com/expressjs/multer#multeropts" target="_blank" rel="noopener noreferrer">the multer constructor<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <div class="custom-block info"><p class="custom-block-title">Note</p> <p><a href="https://github.com/expressjs/multer" target="_blank" rel="noopener noreferrer">Multer<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> is the underlying Express middleware used by NestJS to handle file uploads.</p></div> <p>Now it's your time to work and find out how to restrict file uploads to support only:</p> <ul><li>A maximum file size of 2MB</li> <li><code>png</code> and <code>jpeg</code> image types</li></ul> <p>Some hints to get started:</p> <ul><li>Look at the <a href="https://github.com/expressjs/multer#limits" target="_blank" rel="noopener noreferrer"><code>limits</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> and <a href="https://github.com/expressjs/multer#filefilter" target="_blank" rel="noopener noreferrer"><code>fileFilter</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> options to see how they work.</li> <li>You can get the uploaded file name using <code>file.originalname</code>.</li> <li>Explore Node.js <a href="https://nodejs.org/api/path.html" target="_blank" rel="noopener noreferrer"><code>path</code> module<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> to get extract extension from a file name.</li></ul> <p>Don't forget to test your solution with various scenario using <code>curl</code>, to make sure your API accepts/rejects files properly!</p> <div class="custom-block tip"><p class="custom-block-title">Tip</p> <p>you can use <code>mkfile &lt;size[k|m]&gt; &lt;filename&gt;</code> to generate dummy files with a given size (for Windows users: <code>fsutil file createnew &lt;filename&gt; &lt;size_in_bytes&gt;</code>).</p></div> <h2 id="redeploy"><a href="#redeploy" class="header-anchor">#</a> Redeploy</h2> <p>Once everything works locally let's deploy your latest changes:</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment"># Build your app</span>
<span class="token function">npm</span> run build

<span class="token comment"># Create an archive from your local files and publish it</span>
<span class="token comment"># Don't forget to change the name with the one you used previously</span>
func azure functionapp publish funpets-api --nozip
</code></pre></div><p>Then run again the previous <code>curl</code> command against your deployed API URL to check that everything works fine:</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">curl</span> https://<span class="token operator">&lt;</span>your-funpets-api<span class="token operator">&gt;</span>.azurewebsites.net/api/stories
  -F <span class="token string">&quot;file=@&lt;path_to_image_file&gt;&quot;</span> <span class="token punctuation">\</span>
  -F <span class="token string">&quot;animal=cat&quot;</span> <span class="token punctuation">\</span>
  -F <span class="token string">&quot;description=Happy cat&quot;</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/nitro-workshop/step3/" class="prev">3. Add database</a></span> <span class="next"><a href="/nitro-workshop/step5/">5. Extras</a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/nitro-workshop/assets/js/app.4b20a700.js" defer></script><script src="/nitro-workshop/assets/js/2.37e49c15.js" defer></script><script src="/nitro-workshop/assets/js/10.a7d61bf4.js" defer></script><script src="/nitro-workshop/assets/js/4.f4ff603a.js" defer></script>
  </body>
</html>
